---
title: "Risk Maps"
author: "Anna Boser"
date: "1/29/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(here)
library(lubridate)
library(stringr)
library(dplyr)
library(tidyr)
library(raster)
library(zoo)
library(latex2exp)
```


### Figure 2 - Mordecai equation plot
```{r moredecai, echo=FALSE, warning=FALSE}
T = c(seq(0,100,by=0.1))
mordecai <- data.frame(temperature = T)

coef = 100

ggplot(mordecai, aes(x = temperature)) +
  stat_function(aes(col = "Biting rate"), 
                size = 1, 
                fun = function(x){(1.67*10^-4) * x * (x- 2.3) * (32.0 - x)^(1/2) * coef}, show.legend = TRUE, n = 1000000) + #bite 
  stat_function(aes(col = "Transmission probability"), 
                size = 1, 
                fun = function(x){-(2.94*10^-3) * x * (x - 11.3) * (x - 41.9)}, show.legend = TRUE, n = 1000) + #transmission
  xlim(0, 45) +
  scale_y_continuous(
    name = "Transmission probability (%)",
    limits = c(0,30),
    sec.axis = sec_axis(~./coef, name=TeX("Biting rate ($day^{-1}$)"))) + 
  theme(legend.title = element_blank(), 
        # text=element_text(family = "TT Times New Roman")
        ) + 
  # labs(title = "Culex tarsalis biting and West Nile virus transmission rates", 
  #      subtitle = "From Mordecai et. al., 2019") + 
  xlab(TeX("Temperature ($^o$C)")) + 
  scale_color_manual(values = c("red", "blue")) + 
  guides(size = FALSE) + 
  theme_bw() +
  theme(legend.position = c(0.2, 0.8), legend.title = element_blank()) 
```

```{r}
landcover_avg <- readRDS(here::here("risk_maps",
                                   "data", 
                                   "processed_data", 
                                   "landcover_avgs.RData"))
```


### Paired t-tests by land cover type
```{r}
# Air temperature
t.test(filter(landcover_avg, landcover == "Agriculture")$air_temperature,
       filter(landcover_avg, landcover == "Urban")$air_temperature,
       paired = TRUE)

# biting rate
t.test(filter(landcover_avg, landcover == "Agriculture")$biting_rate,
       filter(landcover_avg, landcover == "Urban")$biting_rate,
       paired = TRUE)

# transmission prob
t.test(filter(landcover_avg, landcover == "Agriculture")$transmission_prob,
       filter(landcover_avg, landcover == "Urban")$transmission_prob,
       paired = TRUE)
```

### Jensen's inequality test 
####(check the role of time resolution over space averages)
```{r}
All <-filter(landcover_avg, landcover == "All")

bite <- function(T){
  bite <- (1.67*10^-4) * T * (T- 2.3) * (32.0 - T)^(1/2)
  bite[is.nan(bite)] <- 0
  return(bite)
}

transmit <- function(T){
  -(2.94*10^-3) * T * (T - 11.3) * (T - 41.9)
}

avg_bite <- All$air_temperature %>% mean() %>% bite
avg_transmit <- All$air_temperature %>% mean() %>% transmit

t.test(x = All$biting_rate, mu = avg_bite)
t.test(x = All$transmission_prob, mu = avg_transmit)
```

####(check the role of spatial resolution with time averages)
```{r}
all_pixels_integrate <- readRDS(here::here("risk_maps",
                               "data", 
                               "processed_data", 
                               "all_pixels_integrate.RData"))

avg_bite <- all_pixels_integrate$air_temperature %>% mean(na.rm = TRUE) %>% bite #there are 3751 pixels on the edge that do not have values for every image, and these we remove. 
avg_transmit <- all_pixels_integrate$air_temperature %>% mean(na.rm = TRUE) %>% transmit

t.test(x = all_pixels_integrate$biting_rate, mu = avg_bite)
t.test(x = all_pixels_integrate$transmission_prob, mu = avg_transmit)
```


### Figure 3 - maps for each time of day
```{r four_maps, echo=FALSE, warning=FALSE}
chosen_four <- list.files(here::here("risk_maps",
                                     "data", 
                                     "raw_data", 
                                     "ECOSTRESS", 
                                     "chosen_four"))

four_panel <- function(type, limits){
  date <- ymd(substr(chosen_four, 14, 23))
  hhmmss <- str_extract(chosen_four, regex('[0-9]{2}:{1}[0-9]{2}:{1}[0-9]{2}'))
  dt <- ymd_hms(paste(date, hhmmss), tz = "America/Los_Angeles")
  
  night <- raster(here::here("risk_maps",
                                     "data", 
                                     "processed_data", 
                                     "ECOSTRESS", 
                                     type, 
                                     chosen_four[1]))
  dawn <- raster(here::here("risk_maps",
                                     "data", 
                                     "processed_data", 
                                     "ECOSTRESS", 
                                     type, 
                                     chosen_four[2]))
  day <- raster(here::here("risk_maps",
                                     "data", 
                                     "processed_data", 
                                     "ECOSTRESS", 
                                     type, 
                                     chosen_four[3]))
  dusk <- raster(here::here("risk_maps",
                                     "data", 
                                     "processed_data", 
                                     "ECOSTRESS", 
                                     type, 
                                     chosen_four[4]))
  
  pal <- colorRampPalette(c("darkblue", "blue", "steelblue1", "white", "yellow", "orange", "red"))
  
  plot(dawn, 
       col = pal(50), 
       # xlim=c(0,55),
       # ylim=c(-10,50),
       zlim=limits,
       xlab="Longitude", 
       ylab = "Latitude")
  title(paste0("Dawn (", dt[2],")"))
  
  plot(day, 
       col = pal(50), 
       # xlim=c(0,55),
       # ylim=c(-10,50),
       zlim=limits,
       xlab="Longitude", 
       ylab = "Latitude")
  title(paste0("Day (", dt[3],")"))
  
  plot(dusk, 
       col = pal(50), 
       # xlim=c(0,55),
       # ylim=c(-10,50),
       zlim=limits,
       xlab="Longitude", 
       ylab = "Latitude")
  title(paste0("Dusk (", dt[4],")"))
  
  plot(night, 
       col = pal(50), 
       # xlim=c(0,55),
       # ylim=c(-10,50),
       zlim=limits,
       xlab="Longitude", 
       ylab = "Latitude")
  title(paste0("Night (", dt[1],")"))
}
```

#### Air Temperature
```{r temp_maps, echo = FALSE}
four_panel("air_temperature", limits = c(11,41))
```

#### Biting rates
```{r b_maps, echo = FALSE}
four_panel("biting_rates", limits = c(0,.27))
```

#### transmission rates
```{r tx_maps, echo = FALSE}
four_panel("transmission_rates", limits = c(0,20))
```

### Figure S3 - maps of errors
```{r erroes, echo = FALSE}
chosen_four <- list.files(here::here("risk_maps",
                                     "data", 
                                     "raw_data", 
                                     "ECOSTRESS", 
                                     "chosen_four"))

regression <- readRDS(file = here("risk_maps", "data", "raw_data", "regression.RDS"))

STANDARD_ERROR <- summary(regression)$sigma

four_panel <- function(risk_function, limits){
  date <- ymd(substr(chosen_four, 14, 23))
  hhmmss <- str_extract(chosen_four, regex('[0-9]{2}:{1}[0-9]{2}:{1}[0-9]{2}'))
  dt <- ymd_hms(paste(date, hhmmss), tz = "America/Los_Angeles")
  
  night <- raster(here::here("risk_maps",
                                     "data", 
                                     "processed_data", 
                                     "ECOSTRESS", 
                                     "air_temperature", 
                                     chosen_four[1]))
  dawn <- raster(here::here("risk_maps",
                                     "data", 
                                     "processed_data", 
                                     "ECOSTRESS", 
                                     "air_temperature", 
                                     chosen_four[2]))
  day <- raster(here::here("risk_maps",
                                     "data", 
                                     "processed_data", 
                                     "ECOSTRESS", 
                                     "air_temperature", 
                                     chosen_four[3]))
  dusk <- raster(here::here("risk_maps",
                                     "data", 
                                     "processed_data", 
                                     "ECOSTRESS", 
                                     "air_temperature", 
                                     chosen_four[4]))
  
  get_error <- function(temp_raster){

    max_error_by_pixel <- function(temperature){

      lower_bound <- temperature - STANDARD_ERROR*1.96
      upper_bound <- temperature + STANDARD_ERROR*1.96

      max <- optimize(risk_function, interval=c(lower_bound, upper_bound), maximum=TRUE)$objective
      min <- optimize(risk_function, interval=c(lower_bound, upper_bound), maximum=FALSE)$objective

      return(max - min)
    }

    values <- raster::values(temp_raster)
    errors <- sapply(values, max_error_by_pixel)
    values(temp_raster) <- errors
    return(temp_raster)
  }
  
  dawn <- get_error(dawn)
  day <- get_error(day)
  dusk <- get_error(dusk)
  night <- get_error(night)
  
  pal <- colorRampPalette(c("darkblue", "blue", "steelblue1", "white", "yellow", "orange", "red"))
  
  plot(dawn, 
       col = pal(50), 
       zlim=limits,
       xlab="Longitude", 
       ylab = "Latitude")
  title(paste0("Dawn (", dt[2],")"))
  
  plot(day, 
       col = pal(50), 
       zlim=limits,
       xlab="Longitude", 
       ylab = "Latitude")
  title(paste0("Day (", dt[3],")"))
  
  plot(dusk, 
       col = pal(50), 
       zlim=limits,
       xlab="Longitude", 
       ylab = "Latitude")
  title(paste0("Dusk (", dt[4],")"))
  
  plot(night, 
       col = pal(50), 
       zlim=limits,
       xlab="Longitude", 
       ylab = "Latitude")
  title(paste0("Night (", dt[1],")"))
}
```

#### Biting rates errors
```{r b_maps_e, echo = FALSE}
bite <- function(T){
  bite <- (1.67*10^-4) * T * (T- 2.3) * (32.0 - T)^(1/2)
  bite <- ifelse(is.nan(bite), 0, bite)
  return(bite)
}

so_i_have_it <- four_panel(bite, limits = c(0,.27))
so_i_have_it
```

#### transmission rates errors -- CODE WRONG. NEEDS CHECK. 
```{r tx_maps_e, echo = FALSE}
transmit <- function(T){
  -(2.94*10^-3) * T * (T - 11.3) * (T - 41.9)
}

four_panel(transmit, limits = c(0,35))
```

### Figure 4 - Distribution of temporal averages over crop types 

#### Integrated values over whole day for pixels close to each other
Because each ECOSTRESS image has a slightly different grid, it is difficult to match the pixels to each other. We do this by resampling all images to the first image.

```{r}
pixels <- readRDS(here::here("risk_maps",
                                         "data", 
                                         "processed_data", 
                                         "all_pixels_integrate_w_landcover.RData")) %>% 
  filter(!is.na(air_temperature))

ag_types <- c("Vegetable", "Orchard", "Fruit", "Field Crop", "Uncultivated")
pixels$landcover <- factor(pixels$landcover, levels = c("Urban",  "Uncultivated", "Vegetable", "Fruit", "Orchard", "Field Crop", "Other"))

filter(pixels, landcover %in% ag_types) %>%
  ggplot(aes(x = air_temperature, col= landcover, alpha = 0.2)) +
  geom_density() +
    guides(alpha = FALSE, col = guide_legend(title = "Crop category")) +
      xlab(TeX("Air temperature ($^o$C)")) +
      ylab("Density") +
  xlim(22.5, 28.5) +
  # labs(title = "Average air temperature distribution") +
  theme_bw() +
  theme(legend.position = c(0.2, 0.8), legend.title = element_blank()) 

filter(pixels, landcover %in% ag_types) %>%
  ggplot(aes(x = transmission_prob, col= landcover, alpha = 0.2)) +
  geom_density() +
    guides(alpha = FALSE, col = guide_legend(title = "Crop category")) +
      xlab("Transmission probability (%)") +
      ylab("Density") +
  xlim(13, 16.5) +
  # labs(title = "Average transmission probability distribution") +
  theme_bw() + 
  guides(color = FALSE)

filter(pixels, landcover %in% ag_types) %>%
  ggplot(aes(x = biting_rate, col= landcover, alpha = 0.2)) +
  geom_density() +
    guides(alpha = FALSE, col = guide_legend(title = "Crop category")) +
      xlab(TeX("Biting rate ($day^{-1}$)")) +
      ylab("Density") +
  xlim(.11, .225) +
  # labs(title = "Average biting rate distribution") +
  theme_bw() + 
  guides(color = FALSE)

# original submission: Instead of just looking at a single daytime frame's pixels, look at all measurements from 11 to 16h (15 frames)

# day_pixels <- readRDS(here::here("risk_maps",
#                                "data", 
#                                "processed_data", 
#                                "day_pixels.RData"))
# 
# ag_types <- c("Vegetable", "Orchard", "Fruit", "Field Crop", "Uncultivated")
# day_pixels$landcover <- factor(day_pixels$landcover, levels = c("Urban",  "Uncultivated", "Vegetable", "Fruit", "Orchard", "Field Crop", "Other"))
# 
# filter(day_pixels, landcover %in% ag_types) %>%
#   ggplot(aes(x = air_temperature, col= landcover, alpha = 0.2)) + 
#   geom_density() + 
#     guides(alpha = FALSE, col = guide_legend(title = "Crop category")) +
#       xlab(TeX("Air temperature ($^o$C)")) + 
#       ylab("Density") + 
#   xlim(25, 36.7) + 
#   labs(title = "Daytime air temperature distribution") + 
#   theme_bw()
# 
# filter(day_pixels, landcover %in% ag_types) %>%
#   ggplot(aes(x = transmission_prob, col= landcover, alpha = 0.2)) + 
#   geom_density() + 
#     guides(alpha = FALSE, col = guide_legend(title = "Crop category")) +
#       xlab("Transmission probability (%)") + 
#       ylab("Density") + 
#   xlim(14.5, 20) + 
#   labs(title = "Daytime transmission probability distribution") + 
#   theme_bw()
```
### f-test on different crop types
```{r}
f_air_temp <- aov(air_temperature ~ landcover, data = filter(pixels, landcover %in% ag_types))
f_trans_prob <- aov(transmission_prob ~ landcover, data = filter(pixels, landcover %in% ag_types))

summary(f_air_temp)
summary(f_trans_prob)
```

### Figure 5 - urban and ag diurnal time series
```{r day_time_series, echo=FALSE, warning=FALSE}
# landcover_avg$landcover <- as.factor(landcover_avg$landcover)

overview <- filter(landcover_avg, landcover %in% c("Urban", "Agriculture"))
overview$landcover <- factor(overview$landcover, levels = c("Urban", "Agriculture"))

#overview plots
ggplot(overview, aes(x = hour(dt) + minute(dt)/60, y = air_temperature, col = landcover, shape = landcover)) + 
      geom_point(size = 2) + #aes(alpha = .2)
      # geom_smooth(method = "lm",
      #         formula = y ~
      #           I(sin((2*pi*(x))/24)) + I(cos((2*pi*(x))/24)) + I(sin((2*2*pi*(x))/24)) + I(cos((2*2*pi*(x))/24)),
      #         se = FALSE) +
      # geom_line(aes(y=rollmedian(air_temperature, 7, na.pad=TRUE))) + 
      xlab("Hour of day") +
      ylab(TeX("Air temperature ($^o$C)")) + 
      labs(title = "Diurnal fluctuations in air temperature") + 
      scale_color_manual(values = c(Urban = "#E66100", All = "#E69F00", Agriculture = "#5D3A9B")) + 
      guides(alpha = FALSE, col = guide_legend(title="Landcover type"), shape = guide_legend(title="Landcover type")) + 
  theme_bw()

ggplot(overview, aes(x = hour(dt) + minute(dt)/60, y = biting_rate, col = landcover, shape = landcover)) + 
      geom_point(size = 2) + 
      # geom_smooth(method = "lm",
      #         formula = y ~
      #           I(sin((2*pi*(x))/24)) + I(cos((2*pi*(x))/24)) + 
      #           I(sin((2*2*pi*(x))/24)) + I(cos((2*2*pi*(x))/24)) + 
      #           I(sin((2*2*2*pi*(x))/24)) + I(cos((2*2*2*pi*(x))/24)),
      #         se = FALSE) +
      xlab("Hour of day") +
      ylim(0,.26) + 
      ylab(TeX("Biting rate ($day^{-1}$)")) + 
      labs(title = "Diurnal fluctuations in biting rates") + 
      scale_color_manual(values = c(Urban = "#E66100", All = "#E69F00", Agriculture = "#5D3A9B")) + 
      guides(alpha = FALSE, col = guide_legend(title="Landcover type"), shape = guide_legend(title="Landcover type")) + 
  theme_bw()

ggplot(overview, aes(x = hour(dt) + minute(dt)/60, y = transmission_prob, col = landcover, shape = landcover)) + 
      geom_point(size = 2) + 
      # geom_smooth(method = "lm",
      #         formula = y ~
      #           I(sin((2*pi*(x))/24)) + I(cos((2*pi*(x))/24)) + 
      #           I(sin((2*2*pi*(x))/24)) + I(cos((2*2*pi*(x))/24)),
      #         se = FALSE) +
      xlab("Hour of day") +
      ylim(0,20) + 
      ylab("Transmission Probability (%)") + 
      labs(title = "Diurnal fluctuations in transmission probabilities") + 
      scale_color_manual(values = c(Urban = "#E66100", All = "#E69F00", Agriculture = "#5D3A9B")) + 
      guides(alpha = FALSE, col = guide_legend(title="Landcover type"), shape = guide_legend(title="Landcover type")) + 
  theme_bw()

```